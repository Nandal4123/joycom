rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // ğŸ¥ ìƒë‹´ì‹ ì²­ì„œ ì»¬ë ‰ì…˜ (consultations)
    // ==========================================
    match /consultations/{document} {
      // ìƒì„±: ëª¨ë“  ì‚¬ìš©ì í—ˆìš© (ìƒë‹´ì‹ ì²­ì„œ ì œì¶œ) - íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ ì œê±°
      allow create: if validateConsultationDataPractical(request.resource.data);
      
      // ì½ê¸°: ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© í—ˆìš© (ì¶”í›„ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½)
      allow read: if true;
      
      // ìˆ˜ì •: ìƒíƒœ ì—…ë°ì´íŠ¸ë§Œ í—ˆìš©
      allow update: if validateStatusUpdatePractical(request.resource.data, resource.data);
      
      // ì‚­ì œ: ì œí•œ (ê´€ë¦¬ìë§Œ)
      allow delete: if false;
    }
    
    // ==========================================
    // ğŸ“ í›„ê¸° ê²Œì‹œíŒ ì»¬ë ‰ì…˜ (reviews)
    // ==========================================
    match /reviews/{document} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì í—ˆìš© (í›„ê¸° ëª©ë¡ ì¡°íšŒ)
      allow read: if true;
      
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ í—ˆìš© - íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ ì œê±°
      allow create: if request.auth != null && validateReviewDataPractical(request.resource.data);
      
      // ìˆ˜ì •: ë³¸ì¸ í›„ê¸°ë§Œ ìˆ˜ì • ê°€ëŠ¥
      allow update: if request.auth != null && 
                    request.auth.uid == resource.data.authorId &&
                    validateReviewUpdatePractical(request.resource.data, resource.data);
      
      // ì‚­ì œ: ë³¸ì¸ í›„ê¸°ë§Œ ì‚­ì œ ê°€ëŠ¥
      allow delete: if request.auth != null && 
                    request.auth.uid == resource.data.authorId;
    }
    
    // ==========================================
    // ğŸ‘¤ ì‚¬ìš©ì ê´€ë¦¬ ì»¬ë ‰ì…˜ (users) - ì„ íƒì‚¬í•­
    // ==========================================
    match /users/{userId} {
      // ë³¸ì¸ ì •ë³´ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ==========================================
    // ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ê³„ì • ì»¬ë ‰ì…˜ (admins) - ì¶”í›„ ì‚¬ìš©
    // ==========================================
    match /admins/{adminId} {
      allow read, write: if request.auth != null && request.auth.uid == adminId;
    }
    
    // ==========================================
    // ğŸ“Š í†µê³„ ì»¬ë ‰ì…˜ (statistics) - ì½ê¸° ì „ìš©
    // ==========================================
    match /statistics/{document} {
      allow read: if true;
      allow write: if false; // Cloud Functionsì—ì„œë§Œ ì—…ë°ì´íŠ¸
    }
    
    // ==========================================
    // ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸ ì»¬ë ‰ì…˜ (ê°œë°œìš©)
    // ==========================================
    match /connection_tests/{document} {
      allow read, write: if true; // í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ëª¨ë“  ì ‘ê·¼ í—ˆìš©
    }
  }
}

// ==========================================
// ğŸ” ì‹¤ìš©ì ì¸ ë°ì´í„° ê²€ì¦ í•¨ìˆ˜ë“¤
// ==========================================

// ìƒë‹´ì‹ ì²­ì„œ ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ (ì‹¤ìš©ì  ë²„ì „)
function validateConsultationDataPractical(data) {
  return 
    // ğŸ“‹ í•„ìˆ˜ í•„ë“œ ì¡´ì¬ í™•ì¸
    'name' in data && 'phone' in data && 'consultationType' in data && 
    'consultationMethod' in data && 'privacyConsent' in data &&
    
    // ğŸ“‹ í•„ìˆ˜ í•„ë“œ íƒ€ì… ë° ê¸¸ì´ ê²€ì¦
    data.name is string && data.name.size() > 0 && data.name.size() <= 100 &&
    data.phone is string && data.phone.size() > 0 && data.phone.size() <= 50 &&
    
    // ğŸ·ï¸ ìƒë‹´ ìœ í˜• ê²€ì¦ (ë¬¸ìì—´ì´ë©´ OK)
    data.consultationType is string && data.consultationType.size() > 0 &&
    
    // ğŸ“ ìƒë‹´ ë°©ì‹ ê²€ì¦ (ë¬¸ìì—´ì´ë©´ OK)
    data.consultationMethod is string && data.consultationMethod.size() > 0 &&
    
    // âœ… ê°œì¸ì •ë³´ ë™ì˜ ê²€ì¦
    data.privacyConsent == true &&
    
    // ğŸ“§ ì„ íƒ í•„ë“œ ê²€ì¦ (ìˆìœ¼ë©´ ê²€ì¦, ì—†ì–´ë„ OK)
    (!('email' in data) || (data.email is string && data.email.size() <= 100)) &&
    (!('message' in data) || (data.message is string && data.message.size() <= 1000)) &&
    (!('preferredDate' in data) || data.preferredDate is string) &&
    (!('preferredTime' in data) || (data.preferredTime is string)) &&
    
    // ğŸ“Œ ìƒíƒœ í•„ë“œ ê²€ì¦ (ìˆìœ¼ë©´ ê²€ì¦, ì—†ì–´ë„ OK)
    (!('status' in data) || data.status is string) &&
    
    // ğŸ†” ì¶”ê°€ í•„ë“œë“¤ í—ˆìš© (source, version ë“±)
    (!('source' in data) || data.source is string) &&
    (!('version' in data) || data.version is string);
    
    // â° íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ì€ ì œê±° (serverTimestamp() ì‚¬ìš© ì‹œ ë¬¸ì œ ë°œìƒ)
}

// ìƒë‹´ì‹ ì²­ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ ê²€ì¦ (ì‹¤ìš©ì  ë²„ì „)
function validateStatusUpdatePractical(newData, oldData) {
  return 
    // ğŸ”’ ê¸°ë³¸ ì •ë³´ëŠ” ë³€ê²½ ë¶ˆê°€
    newData.name == oldData.name &&
    newData.phone == oldData.phone &&
    newData.consultationType == oldData.consultationType &&
    newData.consultationMethod == oldData.consultationMethod &&
    
    // ğŸ”„ ìƒíƒœ ë³€ê²½ë§Œ í—ˆìš©
    newData.status in ['pending', 'contacted', 'scheduled', 'completed', 'cancelled'];
    
    // â° íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ ì œê±° (ìë™ ì²˜ë¦¬)
}

// í›„ê¸° ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ (ì‹¤ìš©ì  ë²„ì „)
function validateReviewDataPractical(data) {
  return 
    // ğŸ“ í•„ìˆ˜ í•„ë“œ ì¡´ì¬ í™•ì¸
    'title' in data && 'content' in data && 'rating' in data && 
    'authorId' in data && 'authorName' in data && 'authorEmail' in data &&
    
    // ğŸ“ í•„ìˆ˜ í•„ë“œ ê²€ì¦
    data.title is string && data.title.size() > 0 && data.title.size() <= 100 &&
    data.content is string && data.content.size() > 0 && data.content.size() <= 1000 &&
    data.rating is int && data.rating >= 1 && data.rating <= 5 &&
    
    // ğŸ‘¤ ì‘ì„±ì ì •ë³´ ê²€ì¦
    data.authorId == request.auth.uid &&
    data.authorName is string && data.authorName.size() > 0 &&
    data.authorEmail is string && data.authorEmail.size() > 0 &&
    
    // ğŸ“Œ ìƒíƒœ ê²€ì¦ (ìˆìœ¼ë©´ ê²€ì¦, ì—†ì–´ë„ OK)
    (!('status' in data) || data.status is string);
    
    // â° íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ ì œê±°
}

// í›„ê¸° ì—…ë°ì´íŠ¸ ê²€ì¦ (ì‹¤ìš©ì  ë²„ì „)
function validateReviewUpdatePractical(newData, oldData) {
  return 
    // ğŸ”’ ê¸°ë³¸ ì‘ì„±ì ì •ë³´ëŠ” ë³€ê²½ ë¶ˆê°€
    newData.authorId == oldData.authorId &&
    newData.authorEmail == oldData.authorEmail &&
    
    // âœï¸ ì œëª©, ë‚´ìš©, ë³„ì ë§Œ ìˆ˜ì • ê°€ëŠ¥
    newData.title is string && newData.title.size() > 0 && newData.title.size() <= 100 &&
    newData.content is string && newData.content.size() > 0 && newData.content.size() <= 1000 &&
    newData.rating is int && newData.rating >= 1 && newData.rating <= 5;
    
    // â° íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ ì œê±° (ìë™ ì²˜ë¦¬)
} 