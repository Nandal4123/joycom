rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // ðŸ¥ ìƒë‹´ì‹ ì²­ì„œ ì»¬ë ‰ì…˜ (consultations)
    // ==========================================
    match /consultations/{document} {
      // ìƒì„±: ëª¨ë“  ì‚¬ìš©ìž í—ˆìš© (ìƒë‹´ì‹ ì²­ì„œ ì œì¶œ)
      allow create: if validateConsultationData(request.resource.data);
      
      // ì½ê¸°: ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© í—ˆìš© (ì¶”í›„ ê´€ë¦¬ìžë§Œ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½)
      allow read: if true;
      
      // ìˆ˜ì •: ìƒíƒœ ì—…ë°ì´íŠ¸ë§Œ í—ˆìš©
      allow update: if validateStatusUpdate(request.resource.data, resource.data);
      
      // ì‚­ì œ: ì œí•œ (ê´€ë¦¬ìžë§Œ)
      allow delete: if false;
    }
    
    // ==========================================
    // ðŸ“ í›„ê¸° ê²Œì‹œíŒ ì»¬ë ‰ì…˜ (reviews)
    // ==========================================
    match /reviews/{document} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ìž í—ˆìš© (í›„ê¸° ëª©ë¡ ì¡°íšŒ)
      allow read: if true;
      
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìžë§Œ í—ˆìš©
      allow create: if request.auth != null && validateReviewData(request.resource.data);
      
      // ìˆ˜ì •: ë³¸ì¸ í›„ê¸°ë§Œ ìˆ˜ì • ê°€ëŠ¥
      allow update: if request.auth != null && 
                    request.auth.uid == resource.data.authorId &&
                    validateReviewUpdate(request.resource.data, resource.data);
      
      // ì‚­ì œ: ë³¸ì¸ í›„ê¸°ë§Œ ì‚­ì œ ê°€ëŠ¥
      allow delete: if request.auth != null && 
                    request.auth.uid == resource.data.authorId;
    }
    
    // ==========================================
    // ðŸ‘¤ ì‚¬ìš©ìž ê´€ë¦¬ ì»¬ë ‰ì…˜ (users) - ì„ íƒì‚¬í•­
    // ==========================================
    match /users/{userId} {
      // ë³¸ì¸ ì •ë³´ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ==========================================
    // ðŸ‘¨â€ðŸ’¼ ê´€ë¦¬ìž ê³„ì • ì»¬ë ‰ì…˜ (admins) - ì¶”í›„ ì‚¬ìš©
    // ==========================================
    match /admins/{adminId} {
      allow read, write: if request.auth != null && request.auth.uid == adminId;
    }
    
    // ==========================================
    // ðŸ“Š í†µê³„ ì»¬ë ‰ì…˜ (statistics) - ì½ê¸° ì „ìš©
    // ==========================================
    match /statistics/{document} {
      allow read: if true;
      allow write: if false; // Cloud Functionsì—ì„œë§Œ ì—…ë°ì´íŠ¸
    }
  }
}

// ==========================================
// ðŸ” ë°ì´í„° ê²€ì¦ í•¨ìˆ˜ë“¤
// ==========================================

// ìƒë‹´ì‹ ì²­ì„œ ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
function validateConsultationData(data) {
  return data.keys().hasAll(['name', 'phone', 'consultationType', 'consultationMethod', 'privacyConsent']) &&
         
         // ðŸ“‹ í•„ìˆ˜ í•„ë“œ ê²€ì¦
         data.name is string && data.name.size() > 0 && data.name.size() <= 50 &&
         data.phone is string && data.phone.size() > 0 && data.phone.size() <= 20 &&
         
         // ðŸ·ï¸ ìƒë‹´ ìœ í˜• ê²€ì¦
         data.consultationType in ['individual', 'couple', 'child', 'art', 'affair', 'petloss'] &&
         
         // ðŸ“ž ìƒë‹´ ë°©ì‹ ê²€ì¦
         data.consultationMethod in ['offline', 'phone', 'online'] &&
         
         // âœ… ê°œì¸ì •ë³´ ë™ì˜ ê²€ì¦
         data.privacyConsent == true &&
         
         // ðŸ“§ ì„ íƒ í•„ë“œ ê²€ì¦
         (!('email' in data) || (data.email is string && data.email.size() <= 100)) &&
         (!('message' in data) || (data.message is string && data.message.size() <= 1000)) &&
         (!('preferredDate' in data) || data.preferredDate is string) &&
         (!('preferredTime' in data) || data.preferredTime in ['morning', 'afternoon', 'evening']) &&
         
         // ðŸ“Œ ìƒíƒœ í•„ë“œ ê²€ì¦
         data.status == 'pending' &&
         
         // â° íƒ€ìž„ìŠ¤íƒ¬í”„ ê²€ì¦
         data.createdAt == request.time &&
         data.updatedAt == request.time;
}

// ìƒë‹´ì‹ ì²­ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ ê²€ì¦
function validateStatusUpdate(newData, oldData) {
  return 
    // ðŸ”’ ê¸°ë³¸ ì •ë³´ëŠ” ë³€ê²½ ë¶ˆê°€
    newData.name == oldData.name &&
    newData.phone == oldData.phone &&
    newData.consultationType == oldData.consultationType &&
    newData.consultationMethod == oldData.consultationMethod &&
    
    // ðŸ”„ ìƒíƒœ ë³€ê²½ë§Œ í—ˆìš©
    newData.status in ['pending', 'contacted', 'scheduled', 'completed', 'cancelled'] &&
    
    // â° ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
    newData.updatedAt == request.time &&
    
    // ðŸš« ìƒì„± ì‹œê°„ì€ ë³€ê²½ ë¶ˆê°€
    newData.createdAt == oldData.createdAt;
}

// í›„ê¸° ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
function validateReviewData(data) {
  return data.keys().hasAll(['title', 'content', 'rating', 'authorId', 'authorName', 'authorEmail']) &&
         
         // ðŸ“ í•„ìˆ˜ í•„ë“œ ê²€ì¦
         data.title is string && data.title.size() > 0 && data.title.size() <= 100 &&
         data.content is string && data.content.size() > 0 && data.content.size() <= 1000 &&
         data.rating is int && data.rating >= 1 && data.rating <= 5 &&
         
         // ðŸ‘¤ ìž‘ì„±ìž ì •ë³´ ê²€ì¦
         data.authorId == request.auth.uid &&
         data.authorName is string && data.authorName.size() > 0 &&
         data.authorEmail is string && data.authorEmail.size() > 0 &&
         
         // ðŸ“Œ ìƒíƒœ ê²€ì¦
         data.status == 'published' &&
         
         // â° íƒ€ìž„ìŠ¤íƒ¬í”„ ê²€ì¦
         data.createdAt == request.time &&
         data.updatedAt == request.time;
}

// í›„ê¸° ì—…ë°ì´íŠ¸ ê²€ì¦
function validateReviewUpdate(newData, oldData) {
  return 
    // ðŸ”’ ê¸°ë³¸ ìž‘ì„±ìž ì •ë³´ëŠ” ë³€ê²½ ë¶ˆê°€
    newData.authorId == oldData.authorId &&
    newData.authorEmail == oldData.authorEmail &&
    
    // âœï¸ ì œëª©, ë‚´ìš©, ë³„ì ë§Œ ìˆ˜ì • ê°€ëŠ¥
    newData.title is string && newData.title.size() > 0 && newData.title.size() <= 100 &&
    newData.content is string && newData.content.size() > 0 && newData.content.size() <= 1000 &&
    newData.rating is int && newData.rating >= 1 && newData.rating <= 5 &&
    
    // â° ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
    newData.updatedAt == request.time &&
    
    // ðŸš« ìƒì„± ì‹œê°„ì€ ë³€ê²½ ë¶ˆê°€
    newData.createdAt == oldData.createdAt;
} 